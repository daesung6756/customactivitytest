<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SMS / Kakaotalk / Survey</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript">
        let sendData = {
            dataType : "SMS",
            totalSizeByte: 162,
            messageSizeByte : 87,
            imageSize : "",
            messages : "",
            imageName : "",
            imageSrc : "",
        }

        const postData = () => {
            // POST 요청을 보내는 함수
            axios.post('http://localhost:9090/test', sendData)
                .then(function (response) {
                    // 응답을 성공적으로 받으면 여기 코드 실행
                    console.log(response.data);
                    alert('POST 전송성공');
                })
                .catch(function (error) {
                    // 에러가 발생하면 여기 코드 실행
                    console.error(error);
                    alert('POST 전송실패');
                });
        };

    </script>
</head>
<body>
<div class="wrap">
    <div class="send-wrap">
        <form>
            <div class="content-area">
                <div class="view">
                    <div class="phone-wrap">
                        <div class="phone">

                            <div class="outer-btns">
                                <span class="left-btn-01"></span>
                                <span class="left-btn-02"></span>
                                <span class="left-btn-03"></span>
                                <span class="right-btn"></span>
                            </div>
                            <div class="phone-head">
                                <div class="status-bar">
                                    <i class="icon icon-wifi"></i>
                                    <i class="icon icon-bluetooth"></i>
                                    <i class="icon icon-lte"></i>
                                    <i class="icon icon-lte-signal"></i>
                                    <i class="icon icon-battery"></i>
                                    <span class="camera"></span>
                                </div>
                            </div>
                            <div class="phone-body">
                                <div class="chat-wrap">
                                    <div class="chat" >
                                        <div class="msg">
                                            <span class="title" data-view-title></span>
                                            <p data-view-content></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="notification-wrap is-ani">SMS</div>
                            </div>
                            <div class="phone-foot" >

                            </div>
                        </div>

                    </div>
                </div>
                <div class="form-wrap">
                    <ul class="form-list">
                        <li>
                            <fieldset class="radio-field">
                                <span class="radio box-type">
                                    <input type="radio" id="sms" name="messageType" data-messagetype checked/>
                                    <label for="sms">SMS</label>
                                </span>
                                <span class="radio box-type">
                                    <input type="radio" id="kko" name="messageType" data-messagetype />
                                    <label for="kko">Kakao</label>
                                </span>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 제목 입력</h3>
                            <fieldset class="text-field">
                                <input type="text" class="input" placeholder="내용을 입력하세요." onkeyup="inputValueViewWrite(this)"/>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 메세지 입력</h3>
                            <fieldset class="text-field">
                                <textarea class="input" placeholder="내용을 입력하세요." onkeyup="inputValueViewWrite(this)" data-insert-textarea></textarea>
                            </fieldset>
                            <p data-view-size class="text-size">0/90 byte</p>
                            <ul style="display:none;">
                                <li>SMS : 한글기준 45자(90byte) 내외의 단문 메시지</li>
                                <li>LMS : 한글기준 1,000자(2,000byte) 내외의 장문 메시지</li>
                                <li>MMS : 한글기준 1,000자(2,000byte) 내외의 장문과 이미지(JPG)를 포함한 메시지</li>
                            </ul>
                        </li>
                        <li>
                            <h3 class="title">- 설문</h3>
                            <p class="desc">* 아래 체크박스를 체크하시면 진행됩니다. 설문은 캠페인에서 설정하세요.</p>
                            <fieldset class="checkbox-group">
                                <input type="checkbox" id="survey" name="survey">
                                <label for="survey">진행</label>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 코드 삽입</h3>
                            <p class="desc">* 메세지 창에 원하는 위치에 마우스 클릭하시면 해당 위치로 등록됩니다.</p>
                            <fieldset class="button-field">
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다2.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 이미지 업로드</h3>
                            <p class="desc in-padding-right">* 이미지 크키는 5MB를 초과하실 수 없습니다.<span id="imageFileSize">0 / 5MB</span></p>
                            <fieldset class="file-field">
                                <input type="text" id="imageFileName" placeholder="파일을 선택하세요." readonly/>
                                <label for="imageFile">파일찾기</label>
                                <input type="file" id="imageFile" onchange="fileSize(this)" />
                            </fieldset>
                            <!--<button type="button" onclick="fileInputReset()">Reset</button>-->
                        </li>
                    </ul>
                </div>
            </div>

            <div class="btn-area">
                <button type="submit" onclick="postData()">전송</button>
            </div>
        </form>

    </div>
</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/postmonger.js"></script>
<script type="text/javascript" src="customActivity.js"></script>
<script type="text/javascript">

    let returnMessage = []

    function inputValueViewWrite(elem) {
        const $title = document.querySelector("[data-view-title]");
        const $content = document.querySelector("[data-view-content]");
        const $value = elem.value;

        const eventOneRequest = setTimeout(() => {
            elem.nodeName === "INPUT" ?
                (
                    returnMessage[1] = $value,
                    $title.innerHTML = returnMessage[1]

                ) : (
                    returnMessage[2] = $value,
                    $content.innerHTML = returnMessage[2]
                )

            getByteLength(returnMessage, 0)

            sendData.messages =
                returnMessage[1] === undefined || returnMessage[2] === undefined ?
                    returnMessage[1] || returnMessage[2] :
                    returnMessage[1] + returnMessage[2]

            console.log(sendData)
            clearTimeout(eventOneRequest)
        }, 300)
    }

    function insertCursorOffset( button ) {
        const $textarea = document.querySelector("[data-insert-textarea]");
        const $value = $textarea.value;
        const $addValue = button.dataset.propsCode;

        let cursorStart = $textarea.selectionStart;
        let cursorEnd = $textarea.selectionEnd;

        const positionBefore = $value.substring(0, cursorStart);  // 기존텍스트 ~ 커서시작점 까지의 문자
        const positionAfter = $value.substring(cursorEnd, $value.length);   // 커서끝지점 ~ 기존텍스트 까지의 문자

        $textarea.value = positionBefore + $addValue + positionAfter;

        inputValueViewWrite($textarea, "[data-view-content]")

        cursorStart = cursorStart + $addValue ;
        $textarea.selectionStart = cursorStart; // 커서 시작점을 추가 삽입된 텍스트 이후로 지정
        $textarea.selectionEnd = cursorStart; // 커서 끝지점을 추가 삽입된 텍스트 이후로 지정
        $textarea.focus();

        sendData.messages = returnMessage
        console.log(sendData)
    }

    function getByteLength ( messages , blank ){
        const elementView = document.querySelector("[data-view-size]")
        let byte = 0;
        const reg = /[ㄱ-ㅎㅏ-ㅣ가-힣一-龥ぁ-ゔァ-ヴー々〆〤]/;

        messages.forEach((msg) => {
            if (blank === 0) {
                msg = msg.replace(/\s+/g,"");
            }

            for( let i=0; i < msg.length;i++) {
                if (reg.test(msg[i])) {
                    byte += 2
                } else {
                    byte++
                }
            }
            elementView.innerHTML = `${byte} byte /90 byte`
        })

    }

    function fileSize ( elem ) {
        const byteUnits = ["kb", "mb", "gb", "tb"];
        const sizeLimit = 5 * 1024 * 1024; //5mb 사용 제한
        const file = elem.files[0];
        const nameView = document.getElementById("imageFileName")
        const sizeView = document.getElementById("imageFileSize")
        const newImage = document.createElement("img");
        const view = document.querySelector("[data-view-content]");

        let size = file.size;

        nameView.value = file.name

        newImage.src = URL.createObjectURL(file)

        sendData.imageName = file.name
        sendData.imageSrc = URL.createObjectURL(file)

        view.appendChild(newImage)

        for (let i = 0; i < byteUnits.length; i++) {
            size = Math.floor(size / 1024);

            if (size < 1024) return sizeView.innerHTML = `${size.toFixed(1)} ${byteUnits[i]}/ 5MB`;
            size < sizeLimit ? alert("사용 용량을 초과하셨습니다.") : false
        }
        console.log(sendData)
    }

    function fileInputReset () {
        const fileInput = document.getElementById("imageFile")
        const nameView = document.getElementById("imageFileName")
        const sizeView = document.getElementById("imageFileSize")
        console.log("리셋")
        fileInput.value = null
        nameView.value = null
        sizeView.innerHTML =  "0 / 5MB"
    }

    const UI = {
        init : function () {
            this.messageTypeSelect.init();
            this.messageInputView.init()
        },
        messageTypeSelect : {
            name: "UI > Message type Radio",
            items : document.querySelectorAll("[data-messagetype]"),
            phoneElement : document.querySelector(".phone-wrap"),
            init: function () {
                this.items.length > 0 ?
                    this.events()
                    : false
            },
            events: function () {
                const _this = this;
                const elem = document.querySelector(".notification-wrap");
                this.items.forEach((radio) => {
                    radio.checked === true ?
                        radio.id === "sms" || radio.id === "kko" ?
                            _this.phoneElement.classList.add(radio.id)
                            : _this.phoneElement.classList.remove(radio.id)
                        : false

                    radio.addEventListener("click", () => {
                        radio.id === "sms" ?
                            (
                                _this.phoneElement.classList.remove("kko"),
                                    _this.phoneElement.classList.add("sms"),
                                    elem.classList.remove("is-hide")
                            ) : (
                                _this.phoneElement.classList.remove("sms"),
                                    _this.phoneElement.classList.add("kko"),
                                    elem.classList.add("is-hide")
                            )

                    })
                })
            }
        },
        messageInputView: {
            name: 'UI > input message view',
            limitByte : 90,
            init : function () {
                this.events()
            },
            events: function () {

            },
            notification : function ( status ) {
                const elem = document.querySelector(".notification-wrap");
                status === "SMS" ? elem.innerHTML = "SMS" : elem.innerHTML = "MMS"
                elem.classList.remove("is-ani")
                const addAnimation = setTimeout(()=> {
                    elem.classList.add("is-ani")
                    clearTimeout(addAnimation)
                }, 300)
            },
        }
    }

    //UI Run
    UI.init()
</script>
</body>
</html>