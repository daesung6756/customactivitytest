<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SMS / Kakaotalk / Survey</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/javascript">
        let sendData = {
            messageType : "",
            messageTitle: "",
            messageContent: "",
            messageTotal : "",
            imageGroup : [],
            surveyStatus: ""
        }
    </script>
</head>
<body>
<div class="wrap">
    <div class="send-wrap">
        <form>
            <div class="content-area">
                <div class="view">
                    <div class="phone-wrap">
                        <div class="phone">

                            <div class="outer-btns">
                                <span class="left-btn-01"></span>
                                <span class="left-btn-02"></span>
                                <span class="left-btn-03"></span>
                                <span class="right-btn"></span>
                            </div>
                            <div class="phone-head">
                                <div class="status-bar">
                                    <i class="icon icon-wifi"></i>
                                    <i class="icon icon-bluetooth"></i>
                                    <i class="icon icon-lte"></i>
                                    <i class="icon icon-lte-signal"></i>
                                    <i class="icon icon-battery"></i>
                                    <span class="camera"></span>
                                </div>
                            </div>
                            <div class="phone-body">
                                <div class="chat-wrap">
                                    <div class="chat" >
                                        <div class="msg">
                                            <span class="title" data-view-title></span>
                                            <p data-view-content></p>
                                            <div data-view-images></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="notification-wrap is-ani">SMS</div>
                            </div>
                            <div class="phone-foot" >

                            </div>
                        </div>

                    </div>
                </div>
                <div class="form-wrap">
                    <ul class="form-list">
                        <li>
                            <fieldset class="radio-field">
                                <span class="radio box-type">
                                    <input type="radio" id="sms" name="messageType" data-messagetype checked/>
                                    <label for="sms">SMS</label>
                                </span>
                                <span class="radio box-type">
                                    <input type="radio" id="kko" name="messageType" data-messagetype />
                                    <label for="kko">Kakao</label>
                                </span>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 제목 입력</h3>
                            <fieldset class="text-field">
                                <input type="text" class="input" placeholder="내용을 입력하세요." onkeyup="inputValueViewWrite(this)"/>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 메세지 입력</h3>
                            <fieldset class="text-field">
                                <textarea class="input" placeholder="내용을 입력하세요." onkeyup="inputValueViewWrite(this)" data-insert-textarea></textarea>
                            </fieldset>
                            <p data-view-size class="text-size">0/90 byte</p>
                            <ul style="display:none;">
                                <li>SMS : 한글기준 45자(90byte) 내외의 단문 메시지</li>
                                <li>LMS : 한글기준 1,000자(2,000byte) 내외의 장문 메시지</li>
                                <li>MMS : 한글기준 1,000자(2,000byte) 내외의 장문과 이미지(JPG)를 포함한 메시지</li>
                            </ul>
                        </li>
                        <li>
                            <h3 class="title">- 설문</h3>
                            <p class="desc">* 아래 체크박스를 체크하시면 진행됩니다. 설문은 캠페인에서 설정하세요.</p>
                            <fieldset class="checkbox-group">
                                <input type="checkbox" id="survey" name="survey" onchange="singleCheckboxReturn(this)">
                                <label for="survey">진행</label>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 코드 삽입</h3>
                            <p class="desc">* 메세지 창에 원하는 위치에 마우스 클릭하시면 해당 위치로 등록됩니다.</p>
                            <fieldset class="button-field">
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다2.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                                <button type="button" onclick="insertCursorOffset(this)" data-props-code="테스트입니다3.">버튼</button>
                            </fieldset>
                        </li>
                        <li>
                            <h3 class="title">- 이미지 업로드</h3>
                            <p class="desc in-padding-right">* 이미지 크키는 MMS기준 (5MB)를 초과하실 수 없습니다.<span id="imageFileSize">0 / 1MB</span></p>
                            <fieldset class="file-field">
                                <label for="imageFile">파일찾기</label>
                                <input type="file" id="imageFile" onchange="addImageToList(this)" />
                                <div class="image-list">
                                    <p>파일을 선택하세요.</p>
                                </div>
                            </fieldset>
                            <!--<button type="button" onclick="fileInputReset()">Reset</button>-->
                        </li>
                    </ul>
                </div>
            </div>

            <div class="btn-area">
                <button type="button" onclick="postData()">저장</button>
            </div>
        </form>

    </div>
</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/postmonger.js"></script>
<script type="text/javascript" src="customActivity.js"></script>
<script type="text/javascript">
    let returnMessage = []
    let imageFileArray = []
    let totalImageSize = 0;

    let messageType
    let messageTitle = returnMessage[1]
    let messageContent = returnMessage[2]
    let messageTotal = returnMessage[1] + returnMessage[2]
    let imageGroup = imageFileArray
    let surveyStatus = false

    // 인풋 작성한 내용 뷰화면 처리
    function inputValueViewWrite(elem) {
        const $title = document.querySelector("[data-view-title]");
        const $content = document.querySelector("[data-view-content]");
        let $value = elem.value;

        const eventOneRequest = setTimeout(() => {
            elem.nodeName === "INPUT" ?
                (
                    returnMessage[1] = $value,
                    $title.innerHTML = returnMessage[1]

                ) : (
                    returnMessage[2] = $value.replaceAll("/\r\n|\r|\n/", "<br/>"),
                    $content.innerHTML = returnMessage[2]
                )

            getByteLength(returnMessage, 0)

            clearTimeout(eventOneRequest)
        }, 300)
    }

    // 싱글 체크박스 값 전달
    function singleCheckboxReturn( elem ) {
        const checkbox = elem;
        return surveyStatus = checkbox.checked
    }

    // 포커스에 컨텐츠 삽입
    function insertCursorOffset( button ) {
        const $textarea = document.querySelector("[data-insert-textarea]");
        const $value = $textarea.value;
        const $addValue = button.dataset.propsCode;

        let cursorStart = $textarea.selectionStart;
        let cursorEnd = $textarea.selectionEnd;

        const positionBefore = $value.substring(0, cursorStart);  // 기존텍스트 ~ 커서시작점 까지의 문자
        const positionAfter = $value.substring(cursorEnd, $value.length);   // 커서끝지점 ~ 기존텍스트 까지의 문자

        $textarea.value = positionBefore + $addValue + positionAfter;

        inputValueViewWrite($textarea, "[data-view-content]")

        cursorStart = cursorStart + $addValue ;
        $textarea.selectionStart = cursorStart; // 커서 시작점을 추가 삽입된 텍스트 이후로 지정
        $textarea.selectionEnd = cursorStart; // 커서 끝지점을 추가 삽입된 텍스트 이후로 지정
        $textarea.focus();
    }

    // 메세지 용량 계산
    function getByteLength ( messages , blank ){
        const elementView = document.querySelector("[data-view-size]")
        let limit = 2000;
        let byte = 0;
        const reg = /[ㄱ-ㅎㅏ-ㅣ가-힣一-龥ぁ-ゔァ-ヴー々〆〤]/;

        messages.forEach((msg) => {
            if (blank === 0) {
                msg = msg.replace(/\s+/g,"");
            }

            for( let i=0; i < msg.length;i++) {
                if (reg.test(msg[i])) {
                    byte += 2
                } else {
                    byte++
                }
            }
            elementView.innerHTML = `${byte} byte /90 byte`
        })

    }

    // 이미지를 리스트와 뷰어에 추가하는 함수
    function addImageToList(fileInput) {
        const files = fileInput.files;

        for (let i = 0; i < files.length; i++) {
            let file = files[i];

            // FileReader를 사용하여 이미지를 읽습니다.
            let reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    // 파일 정보 객체 생성
                    const byteUnits = ["kb","mb","gb","tb"]
                    const sizeView = document.getElementById("imageFileSize");
                    let returnSize =  ""
                    let returnType = ""

                    let size = theFile.size;
                    for (let i = 0; i < byteUnits.length; i++) {
                        size = Math.floor(size / 1024);
                        if (size < 1024) {
                            sizeView.innerHTML = `${size.toFixed(1)} ${byteUnits[i]}/ 5MB`
                            returnSize = size.toFixed(1);
                            returnType = byteUnits[i];
                            break;
                        }
                    }

                    const fileInfo = {
                        name: theFile.name,
                        size: returnSize ,
                        sizeType: returnType ,
                        src: URL.createObjectURL(file)
                    }


                    // 이미지 파일 배열에 파일 정보 추가
                    imageFileArray.push(fileInfo);

                    // 리스트에 이미지 정보 추가
                    updateImageList();
                };
            })(file);

            // 이미지 파일 읽기
            reader.readAsDataURL(file);
        }

        fileInput.value = '';
    }

    // 이미지 추가 용량 처리
    function addSize(size) {
        totalImageSize = totalImageSize + Number(size); // 총 크기에 더합니다.
        updateTotalSizeDisplay();
    }

    // 이미지 삭제 용량 처리
    function subtractSize(size) {
        totalImageSize = totalImageSize - Number(size); // 총 크기에서 뺍니다.
        updateTotalSizeDisplay();
    }

    // 변경사항 이미지 추가/삭제 용량 뷰처리.
    function updateTotalSizeDisplay() {
        const sizeView = document.getElementById("imageFileSize");
        sizeView.innerHTML = `${totalImageSize} kb / 1MB`
        // 여기서는 단순히 콘솔에 로그를 찍고 있지만, 웹페이지에서 적절한 요소를 업데이트해야 합니다.
        console.log(`Total size: ${totalImageSize} bytes`);
    }

    // 이미지 리스트를 업데이트하는 함수
    function updateImageList() {
        const list = document.querySelector('.image-list');
        const view = document.querySelector("[data-view-images]")
        totalImageSize = 0;
        list.innerHTML = ''; // 리스트 초기화
        view.innerHTML = ''; // 이미지 뷰 초기화

        imageFileArray.length > 0 ?

            imageFileArray.forEach(function(fileInfo, index) {
            const listItem = document.createElement('div');
            listItem.className = 'image-list-item';

            const text = document.createTextNode(`${fileInfo.name}, 크기: ${fileInfo.size} bytes`);
            listItem.appendChild(text);

            addSize(fileInfo.size)

            // 삭제 버튼 생성
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '삭제';
            deleteButton.onclick = function() {
                // 이미지 파일 배열과 리스트에서 해당 파일 정보 삭제
                subtractSize(imageFileArray[index].size)
                imageFileArray.splice(index, 1);
                updateImageList();

            };

            listItem.appendChild(deleteButton);

            // 이미지 미리보기 추가
            const imgPreview = document.createElement('img');
            imgPreview.src = fileInfo.src;
            view.appendChild(imgPreview);

            list.appendChild(listItem);
        })
            : list.innerHTML = "<p>파일을 선택하세요.</p>"
    }

    // 작성 내용 서버에 포스트 처리.
    async function postData(){
        sendData = {
            messageType : messageType,
            messageTitle : returnMessage[1],
            messageContent : returnMessage[2],
            messageTotal : returnMessage[1] + returnMessage[2],
            imageGroup : imageFileArray,
            surveyStatus: surveyStatus,
        }

        // POST 요청을 보내는 함수
        const url = 'http://localhost:9090/test';
        axios.post(url, sendData)
            .then((response) => {
                console.log(response.data)
                alert('POST 전송성공')
            })
            .catch((error) => {
                console.error(error);
                alert('POST 전송실패')
            })
    }

    const UI = {
        init : function () {
            this.messageTypeSelect.init();
            this.messageInputView.init()
        },
        messageTypeSelect : {
            name: "UI > Message type Radio",
            items : document.querySelectorAll("[data-messagetype]"),
            phoneElement : document.querySelector(".phone-wrap"),
            init: function () {
                this.items.length > 0 ?
                    this.events()
                    : false
            },
            events: function () {
                const _this = this;
                const elem = document.querySelector(".notification-wrap");
                this.items.forEach((radio) => {
                    radio.checked === true ?
                        radio.id === "sms" || radio.id === "kko" ?
                            (
                                messageType  = "SMS" || "KKO",
                                _this.phoneElement.classList.add(radio.id)
                            ) : _this.phoneElement.classList.remove(radio.id)
                        : false

                    radio.addEventListener("click", () => {
                        radio.id === "sms" ?
                            (
                                _this.phoneElement.classList.remove("kko"),
                                    _this.phoneElement.classList.add("sms"),
                                    elem.classList.remove("is-hide"),
                                    messageType  = "SMS"
                            ) : (
                                _this.phoneElement.classList.remove("sms"),
                                    _this.phoneElement.classList.add("kko"),
                                    elem.classList.add("is-hide"),
                                    messageType  = "KKO"
                            )

                    })
                })
            }
        },
        messageInputView: {
            name: 'UI > input message view',
            limitByte : 90,
            init : function () {
                this.events()
            },
            events: function () {

            },
            notification : function ( status ) {
                const elem = document.querySelector(".notification-wrap");
                status === "SMS" ? elem.innerHTML = "SMS" : elem.innerHTML = "MMS"
                elem.classList.remove("is-ani")
                const addAnimation = setTimeout(()=> {
                    elem.classList.add("is-ani")
                    clearTimeout(addAnimation)
                }, 300)
            },
        }
    }

    //UI Run
    UI.init()

</script>
</body>
</html>